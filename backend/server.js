import express from"express";import dotenv from"dotenv";import cors from"cors";import cookieParser from"cookie-parser";import helmet from"helmet";import hsts from"hsts";import morgan from"morgan";import rateLimit from"express-rate-limit";import http from"http";import{Server as IOServer}from"socket.io";import jwt from"jsonwebtoken";import os from"os";import path from'path';import fs from'fs';import{connectDB}from"./config/db.js";import{notFound,globalErrorHandler}from"./middleware/errorHandler.js";import authRoutes from"./routes/authRoutes.js";import adminAuthRoutes from"./routes/adminAuthRoutes.js";import quizRoutes from"./routes/quizRoutes.js";import paymentRoutes from"./routes/paymentRoutes.js";import userRoutes from'./routes/userRoutes.js';import blogRoutes from"./routes/blogRoutes.js";import adminRoutes from"./routes/adminRoutes.js";import reportRoutes from"./routes/reportRoutes.js";import{webhookHandler}from"./controllers/paymentController.js";import{initializeQuizScheduler,setIoInstance}from"./utils/quizScheduler.js";import{startDeletionWorker}from'./utils/deletionWorker.js';import Quiz from"./models/Quiz.js";import User from"./models/User.js";dotenv.config();const ensureUploadDirs=()=>{const a=path.join(process.cwd(),"uploads","images"),b=path.join(process.cwd(),"uploads","pdfs");if(!fs.existsSync(a)){fs.mkdirSync(a,{recursive:true});console.log("ðŸ“ Created uploads/images directory");}if(!fs.existsSync(b)){fs.mkdirSync(b,{recursive:true});console.log("ðŸ“ Created uploads/pdfs directory");}};ensureUploadDirs();connectDB();const app=express();app.use(helmet({contentSecurityPolicy:{directives:{defaultSrc:["'self'"],scriptSrc:["'self'"],styleSrc:["'self'","'unsafe-inline'"],imgSrc:["'self'","data:","https:","http://localhost:5000","http://127.0.0.1:5000",`http://${os.networkInterfaces().eth0?.filter(i=>i.family==='IPv4')[0]?.address||'localhost'}:5000`],connectSrc:["'self'","wss:","https:"]}},"crossOriginEmbedderPolicy":false,"crossOriginResourcePolicy":{"policy":"cross-origin"},"referrerPolicy":{"policy":"no-referrer"}}));if("production"===process.env.NODE_ENV){app.use(hsts({maxAge:31536000,includeSubDomains:true,preload:true}));app.use((req,res,next)=>{const proto=req.headers["x-forwarded-proto"]||req.protocol;if("https"!==proto){const host=req.headers.host;const url=`https://${host}${req.originalUrl}`;return res.redirect(301,url);}next();});}const allowedOrigins=(process.env.NODE_ENV==="production")?[(process.env.FRONTEND_URL),'https://dailymindeducation.com','https://www.dailymindeducation.com'].filter(Boolean):["http://localhost:3000",`http://${os.networkInterfaces().eth0?.filter(i=>i.family==='IPv4')[0]?.address||'localhost'}:3000`,`http://${os.networkInterfaces().eth0?.filter(i=>i.family==='IPv4')[0]?.address||'localhost'}:3001`,process.env.FRONTEND_URL];app.use(cors({origin:(origin,cb)=>{if(!origin)return cb(null,true);if(allowedOrigins.includes(origin))return cb(null,true);return cb(new Error("CORS blocked"),false);},credentials:true,methods:['GET','POST','PUT','PATCH','DELETE','OPTIONS'],allowedHeaders:['Content-Type','Authorization','Cookie','X-Requested-With']}));app.use(cookieParser());app.use(express.urlencoded({extended:true,limit:'10mb'}));if("development"===process.env.NODE_ENV){app.use(morgan('dev'));}else{app.use(morgan('combined'));}const globalLimiter=rateLimit({windowMs:15*60*1000,max:Number(process.env.GLOBAL_RATE_LIMIT_MAX||1000),message:{success:false,message:'Too many requests from this IP, please try again later.'},standardHeaders:true,legacyHeaders:false});app.use(globalLimiter);const authLimiter=rateLimit({windowMs:15*60*1000,max:Number(process.env.AUTH_RATE_LIMIT_MAX||200),message:{success:false,message:'Too many authentication attempts, please try again later.'},standardHeaders:true,legacyHeaders:false});app.post('/api/payment/webhook',express.raw({type:'application/json'}),webhookHandler);app.use(express.json({limit:'10mb'}));app.use("/uploads",(req,res,next)=>{res.header('Access-Control-Allow-Origin','*');res.header('Access-Control-Allow-Methods','GET, OPTIONS');res.header('Access-Control-Allow-Headers','Content-Type, Authorization');res.header('Cache-Control','public, max-age=31536000');if(req.method==='OPTIONS')return res.sendStatus(200);next();},express.static("uploads",{setHeaders:(res,filePath)=>{res.setHeader('Accept-Ranges','bytes');}}));app.use('/images',express.static(path.join(process.cwd(),'uploads','images'),{setHeaders:(res,filePath)=>{res.setHeader('Cache-Control','public, max-age=31536000');res.setHeader('Accept-Ranges','bytes');}}));app.use('/pdfs',express.static(path.join(process.cwd(),'uploads','pdfs'),{setHeaders:(res,filePath)=>{res.setHeader('Cache-Control','public, max-age=604800');}}));app.get('/health',(req,res)=>{res.json({status:'OK',timestamp:new Date().toISOString(),uptime:process.uptime(),environment:process.env.NODE_ENV||'unknown'});});app.get('/api',(req,res)=>{res.json({message:'Daily Mind Education API',version:'1.0.0',status:'active',timestamp:new Date().toISOString(),endpoints:{auth:'/api/auth',quiz:'/api/quiz',payment:'/api/payment',blogs:'/api/blogs',admin:'/api/admin'}});});app.get('/api/debug/routes',(req,res)=>{res.json({routes:['POST /api/auth/send-otp','POST /api/auth/verify-otp','POST /api/auth/login','POST /api/auth/forgot-password','POST /api/auth/reset-password']});});app.use("/api/auth",authLimiter,authRoutes);app.use("/api/quiz",quizRoutes);app.use("/api/payment",paymentRoutes);app.use("/api/blogs",blogRoutes);app.use("/api",userRoutes);app.use("/api/reports",reportRoutes);app.use("/api/admin",adminRoutes);app.use("/api/admin-auth",adminAuthRoutes);app.use(notFound);app.use(globalErrorHandler);const server=http.createServer(app);const io=new IOServer(server,{cors:{origin:allowedOrigins,credentials:true}});(async()=>{try{if(process.env.REDIS_URL){const{createAdapter}=await import('@socket.io/redis-adapter');const{createClient}=await import('redis');const pubClient=createClient({url:process.env.REDIS_URL});const subClient=pubClient.duplicate();await pubClient.connect();await subClient.connect();io.adapter(createAdapter(pubClient,subClient));console.log('ðŸ”Œ Socket.IO Redis adapter enabled');}}catch(e){console.warn('Redis adapter not enabled:',e.message);}})();const socketAuth=async(socket,next)=>{try{const token=socket.handshake.auth?.token||socket.handshake.headers?.authorization?.split(" ")[1];if(!token)return next(new Error("Authentication error: No token provided"));let decoded;try{decoded=jwt.verify(token,process.env.JWT_SECRET,{algorithms:["HS256"]});}catch(err){return next(new Error("Authentication error: Invalid token"));}if(decoded.exp&&Date.now()>=decoded.exp*1000)return next(new Error("Authentication error: Token expired"));const user=await User.findById(decoded.id).select("-password");if(!user)return next(new Error("Authentication error: User not found"));if(user.isBanned)return next(new Error("Authentication error: User banned"));socket.user=user;socket.userId=user._id.toString();next();}catch(err){console.error("Socket auth error:",err&&err.message?err.message:err);next(new Error("Authentication error"));}};io.use(socketAuth);const activeSockets=new Map();io.on("connection",(socket)=>{console.log(`ðŸ”Œ Socket connected: ${socket.user.fullName} (${socket.userId})`);socket.on("join-room",async({roomId,deviceId})=>{try{const quizId=roomId;const userId=socket.userId;const quiz=await Quiz.findById(quizId);if(!quiz){socket.emit("join-error",{message:"Quiz not found"});return;}if(!quiz.isLive){socket.emit("join-error",{message:"Quiz is not live yet"});return;}const participant=quiz.participants.find(p=>p.user.toString()===userId&&p.paid===true);if(!participant){socket.emit("join-error",{message:"You are not registered or payment not verified"});return;}if(deviceId){const u=await User.findById(userId);if(u){if(!u.deviceId){u.deviceId=deviceId;await u.save();}else if(u.deviceId!==deviceId){if(process.env.NODE_ENV==='production'){socket.emit("join-error",{message:"Device mismatch detected. Please use the same device you registered with."});return;}else{u.deviceId=deviceId;await u.save();}}}}if(!activeSockets.has(userId))activeSockets.set(userId,new Set());const userSockets=activeSockets.get(userId);if(userSockets.size>0){userSockets.forEach(oldSocketId=>{const oldSocket=io.sockets.sockets.get(oldSocketId);if(oldSocket){oldSocket.emit("force-disconnect",{message:"You connected from another device/session"});oldSocket.disconnect(true);}});userSockets.clear();}userSockets.add(socket.id);socket.join(`quiz-${quizId}`);try{await Quiz.findOneAndUpdate({_id:quizId,'participants.user':userId},{$set:{'participants.$.socketId':socket.id,'participants.$.ipAddress':socket.handshake.address,'participants.$.userAgent':socket.handshake.headers['user-agent'],'participants.$.lastSubmissionAt':new Date()}},{new:true});}catch(error){console.error("Join room error:",error);const updatedQuiz=await Quiz.findById(quizId);if(updatedQuiz){const updatedParticipant=updatedQuiz.participants.find(p=>p.user.toString()===userId&&p.paid===true);if(updatedParticipant){try{await Quiz.findOneAndUpdate({_id:quizId,'participants.user':userId},{$set:{'participants.$.socketId':socket.id,'participants.$.ipAddress':socket.handshake.address,'participants.$.userAgent':socket.handshake.headers['user-agent'],'participants.$.lastSubmissionAt':new Date()}});}catch(retryError){console.error("Retry update failed:",retryError);socket.emit("join-error",{message:"Failed to join quiz. Please try again."});return;}}}}console.log(`âœ… ${socket.user.fullName} joined room: quiz-${quizId}`);socket.emit("joined",{roomId:`quiz-${quizId}`});socket.to(`quiz-${quizId}`).emit("user-joined",{userId,username:socket.user.fullName});if(quiz.isLive&&typeof quiz.currentQuestionIndex==='number'&&quiz.currentQuestionIndex>=0){const idx=quiz.currentQuestionIndex;const q=quiz.questions[idx];if(q){const startMs=quiz.questionStartTime?quiz.questionStartTime.getTime():Date.now();const elapsedMs=Date.now()-startMs;const durationMs=(quiz.timePerQuestion||15)*1000;const remainingMs=Math.max(0,durationMs-elapsedMs);socket.emit('question',{questionIndex:idx+1,totalQuestions:quiz.totalQuestions,question:{_id:q._id,text:q.text,options:q.options,category:q.category,points:q.points},timeLeft:remainingMs,startTime:startMs,duration:durationMs});}}}catch(error){console.error("Join room error:",error);socket.emit("join-error",{message:error.message||"Failed to join quiz"});}});socket.on("submit-answer",async(payload)=>{try{const{roomId,questionId,selectedIndex}=payload;const userId=socket.userId;if(!roomId||!userId||!questionId||selectedIndex===undefined){socket.emit("answer-error",{message:"Invalid answer data"});return;}const quiz=await Quiz.findById(roomId);if(!quiz){socket.emit("answer-error",{message:"Quiz not found"});return;}if(!quiz.isLive){socket.emit("answer-error",{message:"Quiz is not live"});return;}const participant=quiz.participants.find(p=>p.user.toString()===userId&&p.paid===true);if(!participant){socket.emit("answer-error",{message:"User not registered for this quiz"});return;}const question=quiz.questions.find(q=>q._id.toString()===questionId);if(!question){socket.emit("answer-error",{message:"Question not found"});return;}const existingAnswer=participant.answers.find(a=>a.questionId.toString()===questionId);if(existingAnswer){socket.emit("answer-error",{message:"Question already answered"});return;}const now=Date.now();const questionStartTime=quiz.questionStartTime?.getTime()||0;const timeElapsed=(now-questionStartTime)/1000;if(timeElapsed>quiz.timePerQuestion+1){socket.emit("answer-error",{message:"Time limit exceeded"});return;}const isCorrect=selectedIndex===question.correctIndex;const points=isCorrect?question.points:0;participant.answers.push({questionId,selectedIndex,correct:isCorrect,timeTaken:Math.round(timeElapsed),points,submittedAt:new Date(),serverTimeReceived:new Date()});participant.score+=points;participant.totalQuestions+=1;if(isCorrect)participant.correctAnswers+=1;participant.timeSpent+=Math.round(timeElapsed);participant.lastSubmissionAt=new Date();await quiz.save();socket.emit("answer-result",{questionId,correct:isCorrect,points,totalScore:participant.score,timeElapsed:Math.round(timeElapsed)});socket.to(`quiz-${roomId}`).emit("participant-answered",{userId,username:socket.user.fullName});}catch(error){console.error("Submit answer error:",error);socket.emit("answer-error",{message:"Failed to process answer"});}});socket.on("complete-quiz",async({roomId})=>{try{const userId=socket.userId;const quiz=await Quiz.findById(roomId);if(!quiz){socket.emit("quiz-error",{message:"Quiz not found"});return;}const participant=quiz.participants.find(p=>p.user.toString()===userId);if(!participant){socket.emit("quiz-error",{message:"User not registered for this quiz"});return;}if(participant.isCompleted){socket.emit("quiz-error",{message:"Quiz already completed"});return;}participant.isCompleted=true;participant.endTime=new Date();const sortedParticipants=quiz.participants.filter(p=>p.isCompleted).sort((a,b)=>b.score - a.score || a.timeSpent - b.timeSpent);const rank=sortedParticipants.findIndex(p=>p.user.toString()===userId)+1;participant.rank=rank;await quiz.save();const user=await User.findById(userId);if(user){const existingHistory=user.quizHistory.find(h=>h.quizId&&h.quizId.toString()===quiz._id.toString());if(!existingHistory){user.quizHistory.push({quizId:quiz._id,score:participant.score,date:quiz.date||new Date(),rank,correctAnswers:participant.correctAnswers,totalQuestions:participant.totalQuestions,timeSpent:participant.timeSpent});await user.save();}else{existingHistory.score=participant.score;existingHistory.rank=rank;existingHistory.correctAnswers=participant.correctAnswers;existingHistory.totalQuestions=participant.totalQuestions;existingHistory.timeSpent=participant.timeSpent;await user.save();}}socket.emit("quiz-completed",{score:participant.score,rank,correctAnswers:participant.correctAnswers,totalQuestions:participant.totalQuestions,timeSpent:participant.timeSpent});}catch(error){console.error("complete-quiz error:",error);socket.emit("quiz-error",{message:"Failed to complete quiz"});}});socket.on("disconnect",(reason)=>{console.log(`ðŸ”Œ Socket disconnected: ${socket.userId} (reason: ${reason})`);if(activeSockets.has(socket.userId)){const set=activeSockets.get(socket.userId);set.delete(socket.id);if(set.size===0)activeSockets.delete(socket.userId);}});});initializeQuizScheduler();setIoInstance(io);try{startDeletionWorker();}catch(e){console.warn('failed to start deletion worker',e&&e.message?e.message:e);}export{io};const PORT=process.env.PORT||5000;server.listen(PORT,'0.0.0.0',()=>{console.log(`ðŸš€ Server running on port ${PORT}`);console.log(`ðŸ’» PC access: http://localhost:${PORT}`);console.log(`ðŸ“± Mobile access: http://${os.networkInterfaces().eth0?.filter(i=>i.family==='IPv4')[0]?.address||'localhost'}:${PORT}`);});